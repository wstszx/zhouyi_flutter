# 周易易理问询APP后端接口需求文档

## 项目概述
基于Flutter开发的周易占卜、八字排盘、问答咨询平台，需要完整的后端API支持用户管理、占卜服务、问答系统、支付等功能。

## 1. 用户认证模块

### 1.1 用户注册
- **接口**: `POST /api/auth/register`
- **功能**: 用户注册
- **参数**:
  ```json
  {
    "phone": "18511111111",
    "password": "88888888",
    "birth_date": "1990-01-01",
    "gender": "男/女",
    "verification_code": "123456"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "注册成功",
    "data": {
      "user_id": 123,
      "phone": "18511111111",
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expires_in": 7200
    }
  }
  ```

### 1.2 用户登录
- **接口**: `POST /api/auth/login`
- **功能**: 支持密码登录和短信登录
- **参数**:
  ```json
  {
    "phone": "18511111111",
    "login_type": "password/sms",
    "password": "88888888", // 密码登录时必填
    "verification_code": "123456" // 短信登录时必填
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "user_id": 123,
      "phone": "18511111111",
      "nickname": "周易算命",
      "avatar": "https://example.com/avatar.jpg",
      "vip_status": false,
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expires_in": 7200
    }
  }
  ```

### 1.3 忘记密码
- **接口**: `POST /api/auth/reset-password`
- **功能**: 重置密码
- **参数**:
  ```json
  {
    "phone": "18511111111",
    "new_password": "88888888",
    "confirm_password": "88888888",
    "verification_code": "123456"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "密码重置成功",
    "data": null
  }
  ```

### 1.4 发送验证码
- **接口**: `POST /api/auth/send-sms`
- **功能**: 发送短信验证码
- **参数**:
  ```json
  {
    "phone": "18511111111",
    "type": "register/login/reset" // 验证码类型
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "验证码发送成功",
    "data": {
      "expires_in": 300, // 5分钟有效期
      "can_resend_after": 60 // 60秒后可重新发送
    }
  }
  ```

## 2. 用户信息管理模块

### 2.1 获取用户信息
- **接口**: `GET /api/user/profile`
- **功能**: 获取用户基本信息
- **返回**:
  ```json
  {
    "user_id": 123,
    "phone": "18511111111",
    "nickname": "周易算命",
    "avatar": "avatar_url",
    "birth_date": "1990-01-01",
    "gender": "男",
    "vip_status": false,
    "vip_expire_date": null,
    "balance": 100.00
  }
  ```

### 2.2 更新用户信息
- **接口**: `PUT /api/user/profile`
- **功能**: 更新用户基本信息
- **参数**:
  ```json
  {
    "nickname": "新昵称",
    "avatar": "新头像URL"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "更新成功",
    "data": {
      "user_id": 123,
      "nickname": "新昵称",
      "avatar": "新头像URL",
      "updated_at": "2025-01-01 10:00:00"
    }
  }
  ```

### 2.3 绑定支付宝/实名认证
- **接口**: `POST /api/user/bind-alipay`
- **功能**: 绑定支付宝账号和实名信息
- **参数**:
  ```json
  {
    "real_name": "张三",
    "id_card": "身份证号",
    "alipay_account": "支付宝账号"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "绑定成功",
    "data": {
      "real_name": "张三",
      "id_card_masked": "3301**********1234",
      "alipay_account_masked": "138****5678",
      "verified": true,
      "bind_time": "2025-01-01 10:00:00"
    }
  }
  ```

## 3. 占卜服务模块

### 3.1 八字排盘
- **接口**: `POST /api/divination/bazi`
- **功能**: 八字排盘分析
- **参数**:
  ```json
  {
    "name": "张三",
    "gender": 1, // 1-男, 0-女
    "birth_datetime": "1990-01-01 08:30:00",
    "birth_location": "北京市"
  }
  ```
- **响应**: 完整的八字分析结果（参考divination_response.json结构）
  ```json
  {
    "code": 200,
    "message": "排盘成功",
    "data": {
      "zhen": {
        "sheng": "北京市",
        "shi": "北京时间",
        "bw": 39.9288,
        "dj": 116.416
      },
      "sex": "男",
      "name": "张三",
      "xmwx": "张(火)三(金)",
      "nylm": "山林之兔",
      "gongli": "1990年01月01日8时30分",
      "nongli": "一九八九年十二月初五卯时",
      "shengxiao": "蛇",
      "xingzuo": "摩羯座",
      "bazi": [
        ["己", "丁", "壬", "癸"],
        ["巳", "丑", "午", "卯"]
      ],
      "nayin": ["大林木", "涧下水", "杨柳木", "金箔金"],
      "wuxingWangdu": "水旺木相火休土囚金死",
      "geju": ["正财格", "身弱"],
      "fx": {
        // 详细分析内容，包含各种古籍分析
        "cgg": ["称骨歌内容"],
        "qiongtongbaojian": "穷通宝鉴分析",
        "rizhufenxi": {
          "riGanXinXing": "日干心性分析",
          "riGanZhiCengCi": "日干支层次",
          "riGanZhiFenXi": "日干支分析"
        }
        // ... 更多分析内容
      }
    }
  }
  ```

### 3.2 保存排盘记录
- **接口**: `POST /api/divination/save-record`
- **功能**: 保存用户的排盘记录
- **参数**:
  ```json
  {
    "name": "张三",
    "gender": "男",
    "birth_datetime": "1990-01-01 08:30:00",
    "result_data": {} // 排盘结果数据
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "保存成功",
    "data": {
      "record_id": 123,
      "name": "张三",
      "gender": "男",
      "birth_datetime": "1990-01-01 08:30:00",
      "created_at": "2025-01-01 10:00:00"
    }
  }
  ```

### 3.3 获取排盘历史
- **接口**: `GET /api/divination/history`
- **功能**: 获取用户的排盘历史记录
- **参数**: `page`, `limit`
- **返回**:
  ```json
  {
    "records": [
      {
        "id": 1,
        "name": "张三",
        "gender": "男",
        "birth_datetime": "1990-01-01 08:30:00",
        "created_at": "2025-01-01 10:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "limit": 20
  }
  ```

### 3.4 删除排盘记录
- **接口**: `DELETE /api/divination/record/{id}`
- **功能**: 删除指定的排盘记录
- **响应**:
  ```json
  {
    "code": 200,
    "message": "删除成功",
    "data": null
  }
  ```

## 4. 问答系统模块

### 4.1 发起新问询
- **接口**: `POST /api/qa/create-question`
- **功能**: 用户发起新问询
- **参数**:
  ```json
  {
    "title": "问题标题",
    "question_type": "choice/essay", // 选择题/问答题
    "birth_info": {
      "name": "张三",
      "gender": "男",
      "birth_datetime": "1990-01-01 08:30:00"
    },
    "questions": [
      {
        "question": "问题内容",
        "type": "choice/essay",
        "options": ["选项A", "选项B", "选项C", "选项D"] // 选择题时必填
      }
    ],
    "reward_amount": 50.00 // 悬赏金额
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "问询发起成功",
    "data": {
      "question_id": 123,
      "title": "问题标题",
      "status": "active",
      "expires_at": "2025-01-04 10:00:00", // 72小时后过期
      "reward_amount": 50.00,
      "created_at": "2025-01-01 10:00:00"
    }
  }
  ```

### 4.2 获取我的问询
- **接口**: `GET /api/qa/my-questions`
- **功能**: 获取用户发起的问询列表
- **参数**: `page`, `limit`, `status`
- **返回**:
  ```json
  {
    "questions": [
      {
        "id": 1,
        "title": "5道选择题",
        "status": "active/ended/closed",
        "remaining_time": "71:22:08",
        "answer_count": 72,
        "created_at": "2025-08-08",
        "reward_amount": 50.00
      }
    ]
  }
  ```

### 4.3 获取问询详情
- **接口**: `GET /api/qa/question/{id}`
- **功能**: 获取问询详细信息和回答列表
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "question_id": 123,
      "title": "5道选择题",
      "question_type": "choice",
      "status": "active",
      "remaining_time": "71:22:08",
      "reward_amount": 50.00,
      "birth_info": {
        "name": "张三",
        "gender": "男",
        "birth_datetime": "1990-01-01 08:30:00"
      },
      "questions": [
        {
          "question": "问题内容",
          "type": "choice",
          "options": ["选项A", "选项B", "选项C", "选项D"]
        }
      ],
      "answers": [
        {
          "answer_id": 456,
          "scholar_name": "187****2568",
          "answers": [
            {
              "question_index": 0,
              "answer": "选项A",
              "explanation": "详细解释"
            }
          ],
          "created_at": "2025-01-01 11:00:00",
          "is_adopted": false
        }
      ],
      "answer_count": 72,
      "created_at": "2025-01-01 10:00:00"
    }
  }
  ```

### 4.4 回答问询
- **接口**: `POST /api/qa/answer`
- **功能**: 学者回答问询
- **参数**:
  ```json
  {
    "question_id": 1,
    "answers": [
      {
        "question_index": 0,
        "answer": "答案内容",
        "explanation": "详细解释"
      }
    ]
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "回答提交成功",
    "data": {
      "answer_id": 456,
      "question_id": 1,
      "scholar_id": 789,
      "created_at": "2025-01-01 11:00:00"
    }
  }
  ```

### 4.5 采纳答案
- **接口**: `POST /api/qa/adopt-answer`
- **功能**: 问询发起者采纳答案
- **参数**:
  ```json
  {
    "question_id": 1,
    "answer_id": 123
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "答案采纳成功",
    "data": {
      "question_id": 1,
      "answer_id": 123,
      "reward_amount": 50.00,
      "adopted_at": "2025-01-01 12:00:00"
    }
  }
  ```

## 5. 一对一咨询模块

### 5.1 获取学者列表
- **接口**: `GET /api/consultation/scholars`
- **功能**: 获取可咨询的学者列表
- **参数**: `page`, `limit`, `specialty`
- **返回**:
  ```json
  {
    "scholars": [
      {
        "id": 1,
        "name": "187****2568",
        "specialty": "八字分析",
        "price": 50.00,
        "rating": 4.8,
        "consultation_count": 1000
      }
    ]
  }
  ```

### 5.2 发起一对一咨询
- **接口**: `POST /api/consultation/create`
- **功能**: 发起一对一咨询
- **参数**:
  ```json
  {
    "scholar_id": 1,
    "consultation_type": "choice/essay",
    "birth_info": {
      "name": "张三",
      "gender": "男",
      "birth_datetime": "1990-01-01 08:30:00"
    },
    "questions": [
      {
        "question": "问题内容",
        "type": "choice/essay",
        "options": ["选项A", "选项B", "选项C", "选项D"]
      }
    ]
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "咨询发起成功",
    "data": {
      "consultation_id": 123,
      "scholar_id": 1,
      "scholar_name": "187****2568",
      "price": 50.00,
      "status": "pending",
      "created_at": "2025-01-01 10:00:00"
    }
  }
  ```

### 5.3 获取咨询历史
- **接口**: `GET /api/consultation/history`
- **功能**: 获取用户的咨询历史
- **参数**: `page`, `limit`, `status`
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "consultations": [
        {
          "consultation_id": 123,
          "scholar_name": "187****2568",
          "consultation_type": "choice",
          "price": 50.00,
          "status": "completed",
          "created_at": "2025-01-01 10:00:00",
          "completed_at": "2025-01-01 11:00:00"
        }
      ],
      "total": 10,
      "page": 1,
      "limit": 20
    }
  }
  ```

## 6. VIP会员模块

### 6.1 获取VIP信息
- **接口**: `GET /api/vip/info`
- **功能**: 获取VIP会员信息和特权说明
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "user_vip_status": false,
      "vip_expire_date": null,
      "packages": [
        {
          "type": "yearly",
          "name": "年度VIP",
          "price": 398.00,
          "original_price": 500.00,
          "discount": "限时优惠"
        }
      ],
      "privileges": [
        "无限制访问所有功能",
        "专属客服一对一服务",
        "咨询费用8折优惠",
        "更多优惠敬请期待"
      ]
    }
  }
  ```

### 6.2 购买VIP
- **接口**: `POST /api/vip/purchase`
- **功能**: 购买VIP会员
- **参数**:
  ```json
  {
    "package_type": "yearly",
    "payment_method": "alipay/wechat"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "订单创建成功",
    "data": {
      "order_id": "VIP202501011000001",
      "package_type": "yearly",
      "amount": 398.00,
      "payment_url": "https://payment.example.com/pay/xxx",
      "expires_in": 900 // 支付链接15分钟有效
    }
  }
  ```

## 7. 支付模块

### 7.1 创建支付订单
- **接口**: `POST /api/payment/create-order`
- **功能**: 创建支付订单
- **参数**:
  ```json
  {
    "order_type": "vip/consultation/reward",
    "amount": 398.00,
    "payment_method": "alipay/wechat",
    "related_id": 123 // 关联的业务ID
  }
  ```

### 7.2 支付回调
- **接口**: `POST /api/payment/callback`
- **功能**: 处理支付平台回调
- **参数**: 根据支付平台规范
- **响应**:
  ```json
  {
    "code": 200,
    "message": "success"
  }
  ```

### 7.3 获取消费记录
- **接口**: `GET /api/payment/consumption-history`
- **功能**: 获取用户消费记录
- **参数**: `page`, `limit`
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "records": [
        {
          "id": 1,
          "order_id": "VIP202501011000001",
          "type": "vip",
          "description": "VIP会员购买",
          "amount": -398.00,
          "status": "completed",
          "created_at": "2025-01-01 10:00:00"
        },
        {
          "id": 2,
          "order_id": "QA202501011100001",
          "type": "consultation",
          "description": "一对一咨询",
          "amount": -50.00,
          "status": "completed",
          "created_at": "2025-01-01 11:00:00"
        }
      ],
      "total": 10,
      "page": 1,
      "limit": 20
    }
  }
  ```

## 8. 消息系统模块

### 8.1 获取消息列表
- **接口**: `GET /api/message/list`
- **功能**: 获取用户消息列表
- **参数**: `page`, `limit`, `type`
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "messages": [
        {
          "id": 1,
          "title": "问询回答通知",
          "content": "您的问询已有新回答，请及时查看",
          "type": "qa_answer",
          "is_read": false,
          "created_at": "2025-01-01 10:00:00"
        },
        {
          "id": 2,
          "title": "VIP开通成功",
          "content": "恭喜您成功开通VIP会员",
          "type": "vip_success",
          "is_read": true,
          "created_at": "2025-01-01 09:00:00"
        }
      ],
      "unread_count": 5,
      "total": 20,
      "page": 1,
      "limit": 20
    }
  }
  ```

### 8.2 标记消息已读
- **接口**: `PUT /api/message/{id}/read`
- **功能**: 标记消息为已读
- **响应**:
  ```json
  {
    "code": 200,
    "message": "标记成功",
    "data": {
      "message_id": 1,
      "is_read": true,
      "read_at": "2025-01-01 10:30:00"
    }
  }
  ```

### 8.3 发送系统消息
- **接口**: `POST /api/message/send`
- **功能**: 发送系统消息（管理员功能）
- **参数**:
  ```json
  {
    "user_ids": [123, 456], // 指定用户，为空则群发
    "title": "消息标题",
    "content": "消息内容",
    "type": "system"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "发送成功",
    "data": {
      "message_id": 789,
      "send_count": 2,
      "created_at": "2025-01-01 10:00:00"
    }
  }
  ```

## 9. 反馈建议模块

### 9.1 提交反馈
- **接口**: `POST /api/feedback/submit`
- **功能**: 用户提交意见反馈
- **参数**:
  ```json
  {
    "type": "bug/suggestion/complaint",
    "content": "反馈内容",
    "contact_info": "联系方式",
    "images": ["image_url1", "image_url2"] // 可选，反馈图片
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "反馈提交成功",
    "data": {
      "feedback_id": 123,
      "type": "suggestion",
      "status": "pending",
      "created_at": "2025-01-01 10:00:00"
    }
  }
  ```

### 9.2 提交个人意见
- **接口**: `POST /api/user/opinion`
- **功能**: 修改个人意见
- **参数**:
  ```json
  {
    "opinion": "个人意见内容"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "保存成功",
    "data": {
      "user_id": 123,
      "opinion": "个人意见内容",
      "updated_at": "2025-01-01 10:00:00"
    }
  }
  ```

## 10. 系统管理模块

### 10.1 获取版本信息
- **接口**: `GET /api/system/version`
- **功能**: 获取当前版本信息和更新说明
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "current_version": "1.0.0",
      "version_name": "初始版本",
      "release_date": "2025-01-01",
      "update_log": [
        "新增八字排盘功能",
        "新增问答系统",
        "新增一对一咨询",
        "新增VIP会员体系"
      ]
    }
  }
  ```

### 10.2 检查更新
- **接口**: `GET /api/system/check-update`
- **功能**: 检查是否有新版本
- **响应**:
  ```json
  {
    "code": 200,
    "message": "检查完成",
    "data": {
      "has_update": false,
      "current_version": "1.0.0",
      "latest_version": "1.0.0",
      "update_info": null,
      "download_url": null,
      "force_update": false
    }
  }
  ```

## 数据库设计要点

### 核心表结构：
1. **users** - 用户基本信息
2. **divination_records** - 排盘记录
3. **questions** - 问询表
4. **answers** - 回答表
5. **scholars** - 学者信息
6. **consultations** - 一对一咨询记录
7. **orders** - 订单表
8. **payments** - 支付记录
9. **messages** - 消息表
10. **feedback** - 反馈表

### 技术要求：
- 支持高并发访问
- 数据安全加密存储
- 支付接口对接（支付宝、微信）
- 短信验证码服务
- 文件存储服务（头像、图片）
- 缓存机制（Redis）
- 日志记录和监控

## 接口通用规范

### 请求头：
```
Authorization: Bearer {token}
Content-Type: application/json
```

### 响应格式：
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1640995200
}
```

### 错误码定义：
- 200: 成功
- 400: 参数错误
- 401: 未授权
- 403: 禁止访问
- 404: 资源不存在
- 500: 服务器错误

## 11. 业务逻辑说明

### 11.1 问询系统业务规则
- 问询有效期：72小时
- 用户同时只能发起一个问询
- 问询结束后才能发起新问询
- 未采纳答案时从签约币扣费
- 支持2-4个选择题或问答题

### 11.2 一对一咨询业务规则
- 按学者设定价格收费
- 支持选择题和问答题两种形式
- 咨询完成后可评价学者
- VIP用户享受折扣优惠

### 11.3 VIP会员特权
- 无限制访问所有功能
- 专属客服一对一服务
- 咨询费用优惠
- 优先回答权限
- 更多功能待开发

### 11.4 积分/余额系统
- 用户充值获得余额
- 消费扣除相应金额
- 支持支付宝、微信支付
- 提供消费记录查询

## 12. 第三方服务集成

### 12.1 占卜API集成
- **当前使用**: `http://zydx.win/api.php`
- **APPID**: 1751103945
- **APPKEY**: 1dc133864f00b7ddce0c1bec5e75575b
- **API类型**: 101 (八字分析)
- **建议**: 可考虑自建占卜算法或多API源备份

### 12.2 短信服务
- 注册验证码
- 登录验证码
- 找回密码验证码
- 建议使用阿里云、腾讯云等服务商

### 12.3 支付服务
- 支付宝支付
- 微信支付
- 需要商户资质和相关证书

### 12.4 文件存储
- 用户头像上传
- 反馈图片上传
- 建议使用OSS对象存储

## 13. 安全考虑

### 13.1 数据安全
- 用户密码加密存储
- 身份证号等敏感信息加密
- API接口签名验证
- SQL注入防护

### 13.2 业务安全
- 短信验证码频率限制
- 支付订单防重复提交
- 用户操作日志记录
- 异常行为监控

### 13.3 接口安全
- JWT Token认证
- 接口访问频率限制
- 参数校验和过滤
- HTTPS传输加密

## 14. 性能优化建议

### 14.1 缓存策略
- 用户信息缓存
- 学者列表缓存
- 占卜结果缓存
- 热点数据预加载

### 14.2 数据库优化
- 合理建立索引
- 读写分离
- 分库分表（用户量大时）
- 慢查询监控

### 14.3 接口优化
- 分页查询
- 数据压缩
- CDN加速
- 异步处理耗时操作

## 15. 监控和运维

### 15.1 系统监控
- 服务器性能监控
- 数据库性能监控
- 接口响应时间监控
- 错误日志监控

### 15.2 业务监控
- 用户注册转化率
- 支付成功率
- 问询完成率
- 用户活跃度

### 15.3 日志管理
- 用户操作日志
- 系统错误日志
- 支付交易日志
- 接口访问日志

## 16. 开发建议

### 16.1 技术栈推荐
- **后端框架**: Spring Boot / Node.js / Django
- **数据库**: MySQL + Redis
- **消息队列**: RabbitMQ / Kafka
- **容器化**: Docker + Kubernetes

### 16.2 开发流程
1. 数据库设计和建表
2. 基础框架搭建
3. 用户认证模块开发
4. 核心业务模块开发
5. 支付模块集成
6. 测试和优化
7. 部署上线

### 16.3 测试要求
- 单元测试覆盖率 > 80%
- 接口自动化测试
- 压力测试
- 安全测试

---

**文档版本**: v1.0
**创建日期**: 2025-01-01
**最后更新**: 2025-01-01
**维护人员**: 开发团队
